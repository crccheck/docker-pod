From 965ecdafccf7669d1b49fde3d00a880966fed894 Mon Sep 17 00:00:00 2001
From: Elvis Pranskevichus <elprans@sprymix.com>
Date: Wed, 9 Jul 2014 10:49:42 -0400
Subject: [PATCH] Add syslog support

---
 thumbor/config.py |  4 ++++
 thumbor/server.py | 20 +++++++++++++++-----
 2 files changed, 19 insertions(+), 5 deletions(-)

diff --git a/thumbor/config.py b/thumbor/config.py
index 8cb4ce7..016952d 100644
--- a/thumbor/config.py
+++ b/thumbor/config.py
@@ -24,6 +24,10 @@ Config.define(
     'THUMBOR_LOG_DATE_FORMAT', '%Y-%m-%d %H:%M:%S',
     'Date Format to be used by thumbor when writing log messages.', 'Logging')
 
+Config.define(
+    'THUMBOR_USE_SYSLOG', False,
+    'Whether thumbor should send its logs to syslog', 'Logging')
+
 Config.define('MAX_WIDTH', 0, "Max width in pixels for images read or generated by thumbor", 'Imaging')
 Config.define('MAX_HEIGHT', 0, "Max height in pixels for images read or generated by thumbor", 'Imaging')
 Config.define('MIN_WIDTH', 1, "Min width in pixels for images read or generated by thumbor", 'Imaging')
diff --git a/thumbor/server.py b/thumbor/server.py
index cdd8f25..bd61960 100644
--- a/thumbor/server.py
+++ b/thumbor/server.py
@@ -10,6 +10,7 @@
 
 import sys
 import logging
+import logging.handlers
 import os
 import socket
 from os.path import expanduser, dirname
@@ -41,11 +42,20 @@ def main(arguments=None):
 
     config = Config.load(server_parameters.config_path, conf_name='thumbor.conf', lookup_paths=lookup_paths)
 
-    logging.basicConfig(
-        level=getattr(logging, server_parameters.log_level.upper()),
-        format=config.THUMBOR_LOG_FORMAT,
-        datefmt=config.THUMBOR_LOG_DATE_FORMAT
-    )
+    if config.THUMBOR_USE_SYSLOG:
+        handler = logging.handlers.SysLogHandler('/dev/log')
+    else:
+        handler = logging.StreamHandler()
+
+    formatter = logging.Formatter(fmt=config.THUMBOR_LOG_FORMAT,
+                                  datefmt=config.THUMBOR_LOG_DATE_FORMAT)
+
+    log_level = getattr(logging, server_parameters.log_level.upper())
+
+    handler.setFormatter(formatter)
+    handler.setLevel(log_level)
+
+    logging.getLogger().addHandler(handler)
 
     importer = Importer(config)
     importer.import_modules()
-- 
2.0.0

